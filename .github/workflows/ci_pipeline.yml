name: DevSecMLOps Pipeline

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  # 1. CODE QUALITY & UNIT TEST (Software 2.0)
  quality-check:
    name: üîç Quality & Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black bandit pytest httpx python-dotenv
          # Install requirements backend agar test API jalan
          if [ -f backend/requirements.txt ]; then pip install -r backend/requirements.txt; fi

      # A. LINTING & FORMATTING
      - name: 1. Lint with Ruff (Fast Linter)
        run: ruff check .

      - name: 2. Format check with Black
        continue-on-error: true
        run: black --check .

      # B. SECURITY SCANNING (SAST) - NEW!
      - name: 3. Security Scan with Bandit
        # Cek folder backend dan mage_pipeline, abaikan test
        run: bandit -r backend/ mage_pipeline/ -ll -ii

      # C. UNIT TESTING
      - name: 4. Run Unit Tests (Pytest)
        env:
          # Dummy env vars agar test tidak gagal koneksi DB
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
          MLFLOW_TRACKING_URI: http://localhost:5000
        run: python -m pytest

  # 2. CONTAINER SECURITY SCANNING (Infrastructure Security)
  container-security:
    name: üê≥ Container Vulnerability Scan
    runs-on: ubuntu-latest
    needs: quality-check # Jalan hanya jika quality-check sukses
    steps:
      - uses: actions/checkout@v3

      # Kita scan Backend Dockerfile sebagai sampel
      - name: Build Backend Image
        run: docker build -t mlops-backend:test ./backend

      - name: Run Trivy Vulnerability Scanner
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'mlops-backend:test'
          format: 'table'
          exit-code: '1' # Gagal jika ada isu CRITICAL
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
